#!/usr/bin/env bash

# Configurable model
MODEL="openai/gpt-5-codex"

# Base branch for diff
BASE_BRANCH="origin/main"

# Initialize variables
ISSUE_CONTEXT=""
EXTRA_INSTRUCTION=""

# Parse arguments
ARGS=()
while [[ $# -gt 0 ]]; do
    case $1 in
        --instruction)
            shift
            EXTRA_INSTRUCTION="$1"
            ;;
        *)
            ARGS+=("$1")
            ;;
    esac
    shift
done

# All positional args are treated as context
ISSUE_CONTEXT="${ARGS[*]}"

# Construct the prompt
PROMPT=$(cat <<EOF
You are an expert developer assistant tasked with generating a Pull Request description
by analyzing the git diff between the current branch and '${BASE_BRANCH}'.

Instructions:

1. Analyze the diff from 'git diff ${BASE_BRANCH}...HEAD'.
2. Extract the current branch name using 'git branch --show-current'.
3. Base the PR description entirely on the diff and the provided context.
4. Output a GitHub-flavored markdown PR description using the following headers:

# PR Title (≤50 chars, conventional commit format)
- Use conventional commit type: feat, fix, docs, style, refactor, test, chore
- If branch contains JIRA ID (ad-1234), include it: feat(ad-1234): description
- Otherwise: feat: description
- Title ≤50 characters
- Must use imperative mood

## Summary
Write a brief one or two paragraph summary of what this PR accomplishes.

## Key Changes
- List major additions, deletions, modifications
- Include any new dependencies or configuration changes

## Testing (optional)
- Describe how changes were tested
- Include any new test files or test scenarios added

## Notes (optional)
- Any follow-ups, migration steps, or breaking changes

Hard wrap all lines at 72 characters.
Context about the issue: ${ISSUE_CONTEXT}
Additional instructions: ${EXTRA_INSTRUCTION}
Append "@coderabbitai ignore" at the end.

Only output the markdown PR description — do not include explanations, code fences, or any extra text.
EOF
)

# Run opencode
opencode run "$PROMPT" -m "$MODEL" --format json \
| jq -r '
      select(
        .type=="response.output_text" or 
        .type=="text" or 
        .type=="response.message.delta"
      ) 
      | (
          if has("data") then .data 
          elif has("part") and (.part | has("text")) then .part.text
          else "" end
        )
    '
